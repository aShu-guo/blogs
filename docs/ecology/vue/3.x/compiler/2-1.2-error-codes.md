# Parser é”™è¯¯æ¢å¤æœºåˆ¶ - ErrorCodes ä¸é”™è¯¯å¤„ç†

Parser çš„é”™è¯¯æ¢å¤æ˜¯ Vue 3 ç¼–è¯‘å™¨çš„ä¸€é¡¹å…³é”®ç‰¹æ€§ï¼Œå®ƒä½¿å¾—ç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨é‡åˆ°è¯­æ³•é”™è¯¯æ—¶**ç»§ç»­è§£æ**ï¼Œè€Œä¸æ˜¯ç›´æ¥åœæ­¢ã€‚è¿™ç§è®¾è®¡æä¾›äº†æ›´å¥½çš„å¼€å‘ä½“éªŒï¼Œå…è®¸å¼€å‘è€…ä¸€æ¬¡æ€§çœ‹åˆ°å¤šä¸ªé”™è¯¯ï¼Œè€Œä¸æ˜¯é€ä¸ªä¿®å¤ã€‚

### æºä»£ç ä½ç½®

- **ErrorCodes æšä¸¾**ï¼š`packages/compiler-core/src/errors.ts:40-109` - æ‰€æœ‰é”™è¯¯ä»£ç å®šä¹‰
- **é”™è¯¯æ¶ˆæ¯æ˜ å°„**ï¼š`packages/compiler-core/src/errors.ts:111-191` - é”™è¯¯ä»£ç åˆ°é”™è¯¯æ¶ˆæ¯çš„æ˜ å°„
- **createCompilerError å·¥å‚å‡½æ•°**ï¼š`packages/compiler-core/src/errors.ts:24-38` - åˆ›å»ºç¼–è¯‘å™¨é”™è¯¯å¯¹è±¡

### é”™è¯¯æ¢å¤çš„è®¾è®¡ç†å¿µ

Vue Parser éµå¾ª**å®¹é”™ç¼–è¯‘**ï¼ˆError Recovery Compilationï¼‰åŸåˆ™ï¼š

```
è¾“å…¥æ¨¡æ¿ï¼ˆåŒ…å«é”™è¯¯ï¼‰
  â†“
å°½å¯èƒ½ç»§ç»­è§£æ
  â†“
æ”¶é›†æ‰€æœ‰é”™è¯¯ä¿¡æ¯
  â†“
è¾“å‡º AST + é”™è¯¯åˆ—è¡¨
  â†“
å¼€å‘è€…çœ‹åˆ°å®Œæ•´çš„é”™è¯¯æŠ¥å‘Š
```

**ä¼˜åŠ¿**ï¼š

- ä¸€æ¬¡æ€§çœ‹åˆ°æ‰€æœ‰é”™è¯¯ï¼Œæé«˜è°ƒè¯•æ•ˆç‡
- å³ä½¿æœ‰é”™è¯¯ä¹Ÿèƒ½ç”Ÿæˆ ASTï¼Œä¾¿äº IDE å·¥å…·é“¾é›†æˆ
- æä¾›ç²¾ç¡®çš„é”™è¯¯ä½ç½®ä¿¡æ¯ï¼Œä¾¿äºä¿®å¤

### ä¸ä¼ ç»Ÿç¼–è¯‘å™¨çš„åŒºåˆ«

```
ä¼ ç»Ÿç¼–è¯‘å™¨ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰ï¼š
ç¬¬ä¸€ä¸ªé”™è¯¯ â†’ åœæ­¢è§£æ âŒ
ç”¨æˆ·éœ€è¦é€ä¸ªä¿®å¤

Vue Parserï¼ˆå®¹é”™æ¨¡å¼ï¼‰ï¼š
é”™è¯¯ 1 â†’ è®°å½• â†’ ç»§ç»­
é”™è¯¯ 2 â†’ è®°å½• â†’ ç»§ç»­
é”™è¯¯ 3 â†’ è®°å½• â†’ ç»§ç»­
  â†“
è¾“å‡ºå®Œæ•´é”™è¯¯åˆ—è¡¨ âœ…
ç”¨æˆ·èƒ½ä¸€æ¬¡æ€§çœ‹åˆ°æ‰€æœ‰é—®é¢˜
```

## ErrorCodes æšä¸¾

Vue Parser å®šä¹‰äº†å®Œæ•´çš„é”™è¯¯ä»£ç æšä¸¾ï¼Œè¦†ç›–å„ä¸ªé˜¶æ®µçš„å¯èƒ½é”™è¯¯ï¼š

```typescript
export enum ErrorCodes {
  // ============ é€šç”¨é”™è¯¯ï¼ˆ1-10ï¼‰============
  GENERIC_ERROR = 0, // é€šç”¨é”™è¯¯

  // ============ æ ‡ç­¾ç›¸å…³é”™è¯¯ï¼ˆ11-30ï¼‰============
  X_INVALID_END_TAG = 11, // æ— æ•ˆçš„ç»“æŸæ ‡ç­¾
  X_MISSING_END_TAG = 12, // ç¼ºå°‘ç»“æŸæ ‡ç­¾
  X_MISSING_END_TAG_BEFORE_EOF = 13, // æ–‡ä»¶æœ«å°¾å‰ç¼ºå°‘ç»“æŸæ ‡ç­¾
  X_MISSING_INTERPOLATION_END = 14, // ç¼ºå°‘æ’å€¼ç»“æŸç¬¦

  // ============ å±æ€§ç›¸å…³é”™è¯¯ï¼ˆ31-50ï¼‰============
  X_INVALID_FIRST_CHARACTER_OF_TAG_NAME = 31, // æ ‡ç­¾åé¦–å­—ç¬¦æ— æ•ˆ
  X_ILLEGAL_CHARACTER_INSIDE_ATTRIBUTE_NAME = 32, // å±æ€§åå†…å­—ç¬¦æ— æ•ˆ
  X_MISSING_ATTRIBUTE_VALUE = 33, // ç¼ºå°‘å±æ€§å€¼
  X_MISSING_WHITESPACE_BETWEEN_ATTRIBUTES = 34, // å±æ€§é—´ç¼ºå°‘ç©ºæ ¼
  X_UNEXPECTED_CHARACTER_IN_ATTRIBUTE_NAME = 35, // å±æ€§åä¸­æ„å¤–å­—ç¬¦
  X_UNEXPECTED_CHARACTER_IN_UNQUOTED_ATTRIBUTE_VALUE = 36, // æ— å¼•å·å±æ€§å€¼ä¸­æ„å¤–å­—ç¬¦

  // ============ å£°æ˜ç›¸å…³é”™è¯¯ï¼ˆ51-70ï¼‰============
  X_AMBIGUOUS_AMPERSAND = 51, // äºŒä¹‰æ€§çš„ &
  X_INCORRECTLY_OPENED_COMMENT = 52, // ä¸æ­£ç¡®æ‰“å¼€çš„æ³¨é‡Š
  X_INCORRECTLY_CLOSED_COMMENT = 53, // ä¸æ­£ç¡®å…³é—­çš„æ³¨é‡Š
  X_UNEXPECTED_EOF_IN_COMMENT = 54, // æ³¨é‡Šä¸­æ„å¤–çš„æ–‡ä»¶æœ«å°¾
  X_UNEXPECTED_EOF_IN_CDATA = 55, // CDATA ä¸­æ„å¤–çš„æ–‡ä»¶æœ«å°¾
  X_UNEXPECTED_EOF_IN_DOCTYPE_DECLARATION = 56, // DOCTYPE å£°æ˜ä¸­æ„å¤–çš„æ–‡ä»¶æœ«å°¾

  // ============ Vue æŒ‡ä»¤ç›¸å…³é”™è¯¯ï¼ˆ61-80ï¼‰============
  X_INVALID_DIRECTIVE_NAME = 61, // æ— æ•ˆçš„æŒ‡ä»¤å
  X_MISSING_DYNAMIC_DIRECTIVE_ARGUMENT_END = 62, // ç¼ºå°‘åŠ¨æ€æŒ‡ä»¤å‚æ•°ç»“æŸç¬¦
  X_V_IF_NO_EXPRESSION = 63, // v-if æ— è¡¨è¾¾å¼
  X_V_IF_SAME_KEY = 64, // v-if/v-else-if é‡å¤ key
  X_V_ELSE_NO_ADJACENT_IF = 65, // v-else æ— ç›¸é‚»çš„ v-if
  X_V_ELSE_IF_NO_EXPRESSION = 66, // v-else-if æ— è¡¨è¾¾å¼
  X_V_FOR_NO_EXPRESSION = 67, // v-for æ— è¡¨è¾¾å¼
  X_V_FOR_MALFORMED_EXPRESSION = 68, // v-for è¡¨è¾¾å¼æ ¼å¼é”™è¯¯
  X_V_BIND_NO_EXPRESSION = 69, // v-bind æ— è¡¨è¾¾å¼
  X_V_ON_NO_EXPRESSION = 70, // @event æ— è¡¨è¾¾å¼
  X_V_SLOT_UNEXPECTED_DIRECTIVE_ON_SLOT_OUTLET = 71, // slot ä¸Šæ„å¤–æŒ‡ä»¤
  X_V_SLOT_MIXED_SLOT_USAGE = 72, // slot ä½¿ç”¨æ··æ·†
  X_V_SLOT_DUPLICATE_SLOT_NAMES = 73, // slot åç§°é‡å¤
  X_V_SLOT_EXTRANEOUS_DEFAULT_SLOT_CHILDREN = 74, // é¢å¤–çš„é»˜è®¤ slot å­èŠ‚ç‚¹
  X_V_SLOT_NAMED_SLOT_OUTSIDE_SCOPED_SLOT = 75, // å…·å slot åœ¨ä½œç”¨åŸŸ slot å¤–
  X_V_MODEL_NO_EXPRESSION = 76, // v-model æ— è¡¨è¾¾å¼
  X_V_MODEL_MALFORMED_EXPRESSION = 77, // v-model è¡¨è¾¾å¼æ ¼å¼é”™è¯¯

  // ============ å…¶ä»–é”™è¯¯ï¼ˆ81-100ï¼‰============
  X_PREFIX_ID_NOT_SUPPORTED = 81, // ä¸æ”¯æŒæ ‡è¯†ç¬¦å‰ç¼€
  X_MODULE_MODE_NOT_SUPPORTED = 82, // ä¸æ”¯æŒæ¨¡å—æ¨¡å¼
  X_CACHE_HANDLER_NOT_SUPPORTED = 83, // ä¸æ”¯æŒäº‹ä»¶å¤„ç†ç¼“å­˜
  X_SCOPE_ID_NOT_SUPPORTED = 84, // ä¸æ”¯æŒ scoped ID
}
```

## é”™è¯¯æ¢å¤ç­–ç•¥

### 1. æ ‡ç­¾ä¸åŒ¹é…æ¢å¤

**åœºæ™¯**ï¼šå¼€æ ‡ç­¾å’Œé—­æ ‡ç­¾ä¸åŒ¹é…

```text
<!-- é”™è¯¯ï¼š<p> æœªé—­åˆ -->
<div>
  <p>paragraph <span>span content</span>
</div>
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// Parser æ ˆçŠ¶æ€è·Ÿè¸ª
Stack: [div]
  â†“ é‡åˆ° <p>
Stack: [div, p]
  â†“ é‡åˆ° <span>ï¼ˆp æœªé—­åˆï¼Œä½†ç»§ç»­ï¼‰
Stack: [div, p, span]
  â†“ é‡åˆ° </span>
Stack: [div, p]
  â†“ é‡åˆ° </div>
  âš ï¸ å‘ç° p æœªé—­åˆ
  âœ“ è‡ªåŠ¨é—­åˆ p
  âœ“ ç»§ç»­å¤„ç† div çš„é—­åˆ
Stack: []
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_MISSING_END_TAG,
  message: "Missing closing tag for element: p",
  loc: { start: 10, line: 2, column: 3 },
  element: 'p'
}
```

**ç”Ÿæˆçš„ AST**ï¼ˆä»ç„¶æ­£ç¡®ï¼‰ï¼š

```
{
  type: NodeTypes.ELEMENT,
  tag: 'div',
  children: [
    {
      type: NodeTypes.ELEMENT,
      tag: 'p',
      children: [{ type: NodeTypes.TEXT, content: 'paragraph' }]
    },
    {
      type: NodeTypes.ELEMENT,
      tag: 'span',
      children: [{ type: NodeTypes.TEXT, content: 'span content' }]
    }
  ]
}
```

### 2. å±æ€§é”™è¯¯æ¢å¤

**åœºæ™¯ 1**ï¼šç¼ºå°‘å±æ€§å€¼

```html
<!-- é”™è¯¯ï¼šclass å±æ€§æ— å€¼ -->
<div class="container" disabled @click="handler">Content</div>
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// å±æ€§è§£æçŠ¶æ€
State: BeforeAttrValue
  â†“ é‡åˆ°ç©ºæ ¼æˆ– > è€Œä¸æ˜¯å±æ€§å€¼
  âœ“ å°†å±æ€§å€¼è®¾ä¸º trueï¼ˆå¸ƒå°”å±æ€§ï¼‰
  âœ“ ç»§ç»­è§£æä¸‹ä¸€ä¸ªå±æ€§æˆ–æ ‡ç­¾ç»“æŸ
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_MISSING_ATTRIBUTE_VALUE,
  message: "Missing value for attribute: disabled",
  loc: { ... },
  attributeName: 'disabled'
}
```

**ç”Ÿæˆçš„ AST**ï¼š

```
{
  type: NodeTypes.ATTRIBUTE,
  name: 'disabled',
  value: { type: NodeTypes.TEXT, content: 'true' }
}
```

**åœºæ™¯ 2**ï¼šå±æ€§åä¸­çš„éæ³•å­—ç¬¦

```html
<!-- é”™è¯¯ï¼šå±æ€§ååŒ…å«ç‰¹æ®Šå­—ç¬¦ -->
<div my-attr@="value" class="box">Content</div>
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// å±æ€§åè§£æ
State: InAttrName
  â†“ é‡åˆ° @ è€Œä¸æ˜¯ = æˆ–ç©ºæ ¼
  âš ï¸ éæ³•å­—ç¬¦ @
  âœ“ è®°å½•é”™è¯¯
  âœ“ å°è¯•æ¢å¤ï¼šå¯èƒ½æ˜¯æ„å¤–çš„ @
  âœ“ è·³è¿‡éæ³•å­—ç¬¦ï¼Œç»§ç»­å¯»æ‰¾ =
```

### 3. æ’å€¼é”™è¯¯æ¢å¤

**åœºæ™¯**ï¼šç¼ºå°‘æ’å€¼ç»“æŸç¬¦

```html
<!-- é”™è¯¯ï¼šç¼ºå°‘ }} -->
<div>
  {{ message
  <p>next element</p>
</div>
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// æ’å€¼è§£æçŠ¶æ€
State: Interpolation
Content: ' message\n  <p>next'
  â†“ æœªæ‰¾åˆ° }}
  âœ“ ç»§ç»­æ‰«æåç»­å†…å®¹
  âœ“ æ£€æµ‹åˆ° < ä¸”å¯èƒ½æ˜¯æ ‡ç­¾ï¼Œè¿›è¡Œæ¢å¤
  âœ“ å‡è®¾æ’å€¼åœ¨æ­¤å¤„ç»“æŸ
  âœ“ é‡æ–°ä»å¯èƒ½çš„æ ‡ç­¾ä½ç½®ç»§ç»­è§£æ
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_MISSING_INTERPOLATION_END,
  message: "Missing closing delimiter for interpolation",
  loc: { start: 8, line: 2, column: 5 }
}
```

### 4. æŒ‡ä»¤è¯­æ³•é”™è¯¯æ¢å¤

**åœºæ™¯ 1**ï¼šv-if æ— è¡¨è¾¾å¼

```html
<!-- é”™è¯¯ï¼šv-if æ— æ¡ä»¶è¡¨è¾¾å¼ -->
<div v-if>Content</div>
â†‘
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// æŒ‡ä»¤è§£æ
Directive: 'if'
Expression: undefined
  âœ“ æ£€æµ‹åˆ°ç¼ºå°‘è¡¨è¾¾å¼
  âœ“ è®°å½•é”™è¯¯
  âœ“ ä¸ºæŒ‡ä»¤åˆ›å»ºç©ºè¡¨è¾¾å¼æˆ–é»˜è®¤è¡¨è¾¾å¼
  âœ“ ç»§ç»­å¤„ç†å…ƒç´ 
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_V_IF_NO_EXPRESSION,
  message: "v-if/v-else-if/v-else require an expression",
  loc: { ... }
}
```

**åœºæ™¯ 2**ï¼šv-for è¡¨è¾¾å¼æ ¼å¼é”™è¯¯

```html
<!-- é”™è¯¯ï¼šv-for è¡¨è¾¾å¼æ ¼å¼é”™è¯¯ -->
<div v-for="item">{{ item }}</div>
â†‘
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// v-for è¡¨è¾¾å¼è§£æ
Expression: "item"
Expected format: "(item, index) in list" or "item in list"
  âœ“ æ£€æµ‹åˆ°æ ¼å¼é”™è¯¯
  âœ“ å°è¯•å„ç§è§£æç­–ç•¥ï¼š
    - item â†’ å¯èƒ½æ˜¯è¿­ä»£æº
    - å°è¯•æ¨æ–­ç¼ºå¤±çš„éƒ¨åˆ†
  âœ“ ä½¿ç”¨æœ€åˆç†çš„è§£æç»“æœ
  âœ“ è®°å½•é”™è¯¯
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_V_FOR_MALFORMED_EXPRESSION,
  message: "v-for expression must be in the form: (item, index) in list",
  loc: { ... }
}
```

### 5. æ³¨é‡Šé”™è¯¯æ¢å¤

**åœºæ™¯**ï¼šä¸æ­£ç¡®çš„æ³¨é‡Šè¯­æ³•

```html
<!-- é”™è¯¯ï¼šæ³¨é‡Šæœªé—­åˆ -->
<!-- This is a comment
<div>Content</div>
```

**æ¢å¤è¿‡ç¨‹**ï¼š

```
// æ³¨é‡Šè§£æçŠ¶æ€
State: InComment
Content: ' This is a comment\n'
  â†“ åœ¨æ–‡ä»¶æœ«å°¾æˆ–ä¸‹ä¸€ä¸ªå¯èƒ½çš„åˆ†ç•Œç¬¦å¤„
  âœ“ æ£€æµ‹åˆ°æ³¨é‡Šæœªé—­åˆ
  âœ“ è®°å½•é”™è¯¯
  âœ“ åœ¨å½“å‰ä½ç½®æˆ–æ–‡ä»¶æœ«å°¾å‡è®¾æ³¨é‡Šç»“æŸ
  âœ“ ç»§ç»­è§£æåç»­å†…å®¹
```

**é”™è¯¯è®°å½•**ï¼š

```
{
  code: ErrorCodes.X_UNEXPECTED_EOF_IN_COMMENT,
  message: "Unexpected EOF in comment",
  loc: { ... }
}
```

## å®Œæ•´é”™è¯¯æ¢å¤ç¤ºä¾‹

### è¾“å…¥æ¨¡æ¿ï¼ˆåŒ…å«å¤šä¸ªé”™è¯¯ï¼‰

```html
<template>
  <div class="app" id=
    <p>{{ message
    <button v-if @click="handler">
      Click me
    </button>
    <span v-for="item">{{ item }}</span>
  </div>
</template>
```

**é”™è¯¯åˆ—è¡¨**ï¼ˆæ”¶é›†çš„æ‰€æœ‰é”™è¯¯ï¼‰ï¼š

1. **ç¼ºå°‘å±æ€§å€¼**

   ```
   Error: X_MISSING_ATTRIBUTE_VALUE
   Location: Line 2, Column 19
   Message: Missing value for attribute: id
   ```

2. **ç¼ºå°‘æ’å€¼ç»“æŸç¬¦**

   ```
   Error: X_MISSING_INTERPOLATION_END
   Location: Line 3, Column 16
   Message: Missing closing delimiter for interpolation
   ```

3. **v-if æ— è¡¨è¾¾å¼**

   ```
   Error: X_V_IF_NO_EXPRESSION
   Location: Line 4, Column 11
   Message: v-if/v-else-if/v-else require an expression
   ```

4. **v-for è¡¨è¾¾å¼æ ¼å¼é”™è¯¯**
   ```
   Error: X_V_FOR_MALFORMED_EXPRESSION
   Location: Line 7, Column 15
   Message: v-for expression must be in the form: (item, index) in list
   ```

### ç”Ÿæˆçš„ ASTï¼ˆä»ç„¶å¯ç”¨ï¼‰

```
{
  type: NodeTypes.ROOT,
  children: [
    {
      type: NodeTypes.ELEMENT,
      tag: 'div',
      props: [
        {
          type: NodeTypes.ATTRIBUTE,
          name: 'class',
          value: { type: NodeTypes.TEXT, content: 'app' }
        },
        {
          type: NodeTypes.ATTRIBUTE,
          name: 'id',
          value: { type: NodeTypes.TEXT, content: '' }  // ç©ºå€¼ï¼ˆæ¢å¤ï¼‰
        }
      ],
      children: [
        {
          type: NodeTypes.ELEMENT,
          tag: 'p',
          children: [
            {
              type: NodeTypes.INTERPOLATION,
              content: { type: NodeTypes.SIMPLE_EXPRESSION, content: ' message' }
            }
          ]
        },
        {
          type: NodeTypes.ELEMENT,
          tag: 'button',
          props: [
            {
              type: NodeTypes.DIRECTIVE,
              name: 'if',
              exp: { type: NodeTypes.SIMPLE_EXPRESSION, content: '' }  // ç©ºè¡¨è¾¾å¼ï¼ˆæ¢å¤ï¼‰
            },
            {
              type: NodeTypes.DIRECTIVE,
              name: 'on',
              arg: { type: NodeTypes.SIMPLE_EXPRESSION, content: 'click' },
              exp: { type: NodeTypes.SIMPLE_EXPRESSION, content: 'handler' }
            }
          ],
          children: [{ type: NodeTypes.TEXT, content: 'Click me' }]
        },
        {
          type: NodeTypes.ELEMENT,
          tag: 'span',
          props: [
            {
              type: NodeTypes.DIRECTIVE,
              name: 'for',
              exp: { type: NodeTypes.SIMPLE_EXPRESSION, content: 'item' }  // æ¢å¤çš„è¡¨è¾¾å¼
            }
          ],
          children: [{ type: NodeTypes.INTERPOLATION, ... }]
        }
      ]
    }
  ],
  helpers: Set<symbol>,    // æ‰€éœ€çš„å¸®åŠ©å‡½æ•°
  components: [],          // è‡ªå®šä¹‰ç»„ä»¶åˆ—è¡¨
  directives: [],          // è‡ªå®šä¹‰æŒ‡ä»¤åˆ—è¡¨
  hoists: [],              // æå‡çš„é™æ€èŠ‚ç‚¹
  imports: []              // å¯¼å…¥è¯­å¥
}
```

## é”™è¯¯è·å–æ–¹å¼

### è°ƒç”¨é“¾æ¡

```
ç”¨æˆ·ä»£ç 
  â†“
compile (compiler-dom/src/index.ts)
  â”œâ”€ æ¥æ”¶ options.onError
  â””â”€ è°ƒç”¨ baseCompile(template, opts)
     â†“
baseCompile (compiler-core/src/compile.ts)
  â”œâ”€ æå– onError = options.onError
  â”œâ”€ è°ƒç”¨ baseParse(template, { onError })
  â”‚  â”œâ”€ åˆ›å»º ParserContext { onError }
  â”‚  â””â”€ æ‰§è¡Œ Parser.parse()
  â”‚     â”œâ”€ æ‰«ææ¨¡æ¿
  â”‚     â”œâ”€ é‡åˆ°é”™è¯¯ â†’ context.onError(error)
  â”‚     â””â”€ é”™è¯¯æ¢å¤ï¼Œç»§ç»­è§£æ
  â”œâ”€ è°ƒç”¨ transform(ast, { onError })
  â”‚  â””â”€ transform é˜¶æ®µä¹Ÿå¯èƒ½äº§ç”Ÿé”™è¯¯
  â””â”€ è°ƒç”¨ generate(ast, options)
     â†“
ç”¨æˆ·çš„ onError å›è°ƒè¢«æ‰§è¡Œ
  â†“
é”™è¯¯è¢«æ”¶é›†åˆ°ç”¨æˆ·çš„é”™è¯¯æ•°ç»„
```

### ç®€åŒ–ç¤ºä¾‹

```typescript
// ç”¨æˆ·ä»£ç 
const errors = []
const result = compile(template, {
  onError: (error) => errors.push(error)
})

// å†…éƒ¨æµç¨‹
// compile()
//   â†’ baseCompile()
//     â†’ baseParse(template, { onError })
//       â†’ Parser.parse()
//         â†’ context.onError(error)
//           â†’ ç”¨æˆ·çš„ onError å›è°ƒ
//             â†’ errors.push(error)
```



## é”™è¯¯æ¢å¤çš„å®ç°æœºåˆ¶

### æ ˆæœºåˆ¶é”™è¯¯æ¢å¤

```typescript
// Parser ç»´æŠ¤æ ˆæ¥è¿½è¸ªåµŒå¥—å…ƒç´ 
class Parser {
  private stack: ElementNode[] = [];
  private errors: CompilerError[] = [];

  // å¤„ç†é—­æ ‡ç­¾æ—¶çš„æ¢å¤
  handleCloseTag(tagName: string) {
    // 1. æŸ¥æ‰¾åŒ¹é…çš„å¼€æ ‡ç­¾
    let j = this.stack.length - 1;
    while (j >= 0) {
      if (this.stack[j].tag.toLowerCase() === tagName.toLowerCase()) {
        break;
      }
      j--;
    }

    if (j < 0) {
      // æœªæ‰¾åˆ°åŒ¹é…çš„å¼€æ ‡ç­¾
      this.errors.push({
        code: ErrorCodes.X_INVALID_END_TAG,
        message: `Unexpected closing tag: ${tagName}`,
        loc: this.getLoc(),
      });
      return; // æ¢å¤ï¼šå¿½ç•¥è¿™ä¸ªé”™è¯¯çš„é—­æ ‡ç­¾
    }

    // 2. æ£€æŸ¥ä¸­é—´æ˜¯å¦æœ‰æœªé—­åˆçš„æ ‡ç­¾
    const unclosedTags = this.stack.slice(j + 1);
    for (const tag of unclosedTags) {
      this.errors.push({
        code: ErrorCodes.X_MISSING_END_TAG,
        message: `Missing closing tag for element: ${tag.name}`,
        loc: tag.loc,
      });
    }

    // 3. å¼¹å‡ºæ‰€æœ‰æœªé—­åˆçš„æ ‡ç­¾ï¼ˆåŒ…æ‹¬åŒ¹é…çš„æ ‡ç­¾ï¼‰
    this.stack.length = j;
  }
}
```

### çŠ¶æ€æœºæ¢å¤

```typescript
// Tokenizer çŠ¶æ€æœºä¸­çš„æ¢å¤æœºåˆ¶
class Tokenizer {
  private state: State = State.Text;

  // å¤„ç†æ— æ•ˆçŠ¶æ€è½¬ç§»
  private handleInvalidTransition(char: string) {
    // 1. å°è¯•æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„çŠ¶æ€
    const nextValidState = this.findNextValidState(char);

    if (nextValidState) {
      // 2. è®°å½•é”™è¯¯
      this.errors.push({
        code: this.getErrorCode(this.state, char),
        message: `Unexpected character '${char}' in ${this.state}`,
        loc: this.getLoc(),
      });

      // 3. è¿›è¡Œæ¢å¤
      this.state = nextValidState;
    } else {
      // 4. å¦‚æœæ— æ³•æ¢å¤ï¼Œè·³è¿‡è¯¥å­—ç¬¦
      this.position++;
    }
  }
}
```

### è¡¨è¾¾å¼è§£ææ¢å¤

```typescript
// æŒ‡ä»¤è¡¨è¾¾å¼è§£æä¸­çš„æ¢å¤
function parseDirectiveExpression(node: DirectiveNode): SimpleExpressionNode {
  const content = node.exp?.content || '';

  // 1. å°è¯•è§£æè¡¨è¾¾å¼
  try {
    return parseExpression(content);
  } catch (e) {
    // 2. è§£æå¤±è´¥ï¼Œè®°å½•é”™è¯¯
    errors.push({
      code: getErrorCode(node.name),
      message: `Malformed ${node.name} expression: ${content}`,
      loc: node.loc,
    });

    // 3. è¿”å›å®¹é”™çš„ç©ºè¡¨è¾¾å¼
    return createSimpleExpression(content, false);
  }
}
```

## é”™è¯¯ç­‰çº§å’Œä¸¥é‡æ€§

### åˆ†ç±»

```typescript
enum ErrorSeverity {
  // è­¦å‘Šï¼šä¸ä¼šå½±å“ç¼–è¯‘
  WARNING = 0,

  // é”™è¯¯ï¼šä¼šå½±å“æŸä¸ªåŠŸèƒ½ï¼Œä½†æ•´ä½“å¯ç»§ç»­
  ERROR = 1,

  // ä¸¥é‡é”™è¯¯ï¼šåº”è¯¥å°½å¿«ä¿®å¤
  FATAL = 2,
}

// é”™è¯¯ç­‰çº§æ˜ å°„
const ErrorSeverityMap: Record<ErrorCodes, ErrorSeverity> = {
  // è­¦å‘Š
  [ErrorCodes.X_AMBIGUOUS_AMPERSAND]: ErrorSeverity.WARNING,
  [ErrorCodes.X_INCORRECTLY_OPENED_COMMENT]: ErrorSeverity.WARNING,

  // é”™è¯¯
  [ErrorCodes.X_MISSING_END_TAG]: ErrorSeverity.ERROR,
  [ErrorCodes.X_MISSING_ATTRIBUTE_VALUE]: ErrorSeverity.ERROR,
  [ErrorCodes.X_V_IF_NO_EXPRESSION]: ErrorSeverity.ERROR,

  // ä¸¥é‡é”™è¯¯
  [ErrorCodes.X_INVALID_FIRST_CHARACTER_OF_TAG_NAME]: ErrorSeverity.FATAL,
  [ErrorCodes.X_INVALID_DIRECTIVE_NAME]: ErrorSeverity.FATAL,
};
```

### å¤„ç†æ–¹å¼

```typescript
function handleError(error: CompilerError) {
  const severity = ErrorSeverityMap[error.code];

  switch (severity) {
    case ErrorSeverity.WARNING:
      console.warn(`âš ï¸  Warning at ${error.loc}: ${error.message}`);
      break;

    case ErrorSeverity.ERROR:
      console.error(`âŒ Error at ${error.loc}: ${error.message}`);
      break;

    case ErrorSeverity.FATAL:
      console.error(`ğŸ”´ Fatal error at ${error.loc}: ${error.message}`);
      // å¯é€‰ï¼šåœ¨ä¸¥é‡é”™è¯¯æ—¶åœæ­¢è§£æ
      throw new Error(`Cannot recover from: ${error.message}`);
  }
}
```

## å¼€å‘è€…é”™è¯¯å¤„ç† API

### ä½¿ç”¨ onError å›è°ƒ

```typescript
import { parse } from '@vue/compiler-core';

const template = `
  <div class="app" id=
    <p>{{ message
  </div>
`;

const errors: CompilerError[] = [];

const ast = parse(template, {
  onError: (error) => {
    errors.push(error);

    // è‡ªå®šä¹‰å¤„ç†
    if (error.code === ErrorCodes.X_MISSING_END_TAG) {
      console.warn(`Missing end tag: ${error.message}`);
    }
  },
});

// è·å–æ‰€æœ‰é”™è¯¯
console.log('Total errors:', errors.length);
errors.forEach((error) => {
  console.error(`[${error.code}] ${error.message}`);
  console.error(
    `  at line ${error.loc.start.line}, column ${error.loc.start.column}`,
  );
  console.error(`  ${error.loc.source}`);
});
```

### é”™è¯¯ç»Ÿè®¡å’ŒæŠ¥å‘Š

```typescript
class ErrorReporter {
  private errors: Map<ErrorCodes, number> = new Map();

  report(error: CompilerError) {
    const count = this.errors.get(error.code) ?? 0;
    this.errors.set(error.code, count + 1);
  }

  getReport(): string {
    const lines: string[] = ['Error Summary:'];
    lines.push('â”€'.repeat(50));

    for (const [code, count] of this.errors) {
      const message = ErrorCodeMessages[code];
      lines.push(`  ${code}: ${message} (${count}x)`);
    }

    return lines.join('\n');
  }
}

// ä½¿ç”¨
const reporter = new ErrorReporter();
const ast = parse(template, {
  onError: (error) => reporter.report(error),
});

console.log(reporter.getReport());
```

## å¸¸è§é”™è¯¯æ¨¡å¼ä¸è§£å†³æ–¹æ¡ˆ

### æ¨¡å¼ 1ï¼šæ ‡ç­¾ä¸åŒ¹é…

**é”™è¯¯æ¨¡æ¿**ï¼š

```html
<div>
  <p>content <span>more</span></p>
</div>
```

**Parser è¡Œä¸º**ï¼š

- å‘ç° `</div>` æ—¶ï¼Œæ ˆä¸­æœ‰ `[div, p]`
- è‡ªåŠ¨é—­åˆ `p`ï¼Œç”Ÿæˆé”™è¯¯ï¼š`X_MISSING_END_TAG`
- ç»§ç»­æ­£å¸¸å¤„ç† `</div>`

**ä¿®å¤å»ºè®®**ï¼šæ·»åŠ  `</p>`

### æ¨¡å¼ 2ï¼šå±æ€§è¯­æ³•é”™è¯¯

**é”™è¯¯æ¨¡æ¿**ï¼š

```html
<div class id="box" style="">Content</div>
```

**Parser è¡Œä¸º**ï¼š

1. `class` æ— å€¼ â†’ é”™è¯¯ï¼š`X_MISSING_ATTRIBUTE_VALUE`
2. `style` æ— å€¼ â†’ é”™è¯¯ï¼š`X_MISSING_ATTRIBUTE_VALUE`
3. ä½†ä»æ­£ç¡®è§£æå±æ€§

**ä¿®å¤å»ºè®®**ï¼šä¸ºå±æ€§æä¾›å€¼

### æ¨¡å¼ 3ï¼šæŒ‡ä»¤è¡¨è¾¾å¼ç¼ºå¤±

**é”™è¯¯æ¨¡æ¿**ï¼š

```html
<div v-if v-for>Content</div>
```

**Parser è¡Œä¸º**ï¼š

1. `v-if` æ— è¡¨è¾¾å¼ â†’ é”™è¯¯ï¼š`X_V_IF_NO_EXPRESSION`
2. `v-for` æ— è¡¨è¾¾å¼ â†’ é”™è¯¯ï¼š`X_V_FOR_MALFORMED_EXPRESSION`
3. åˆ›å»ºç©ºè¡¨è¾¾å¼èŠ‚ç‚¹

**ä¿®å¤å»ºè®®**ï¼šä¸ºæŒ‡ä»¤æ·»åŠ è¡¨è¾¾å¼

### æ¨¡å¼ 4ï¼šæ’å€¼ä¸å®Œæ•´

**é”™è¯¯æ¨¡æ¿**ï¼š

```html
<div>{{ message1 {{ message2 }}</div>
```

**Parser è¡Œä¸º**ï¼š

1. ç¬¬ä¸€ä¸ª <span v-pre>`{{ message1`</span> æœªé—­åˆ
2. é‡åˆ°ç¬¬äºŒä¸ª <span v-pre>`{{`</span>ï¼Œè§¦å‘ï¼š`X_MISSING_INTERPOLATION_END`
3. å°è¯•æ¢å¤ï¼Œå¯èƒ½åˆ†æˆä¸¤ä¸ªç‹¬ç«‹çš„æ’å€¼

**ä¿®å¤å»ºè®®**ï¼šç¡®ä¿æ¯ä¸ª <span v-pre>`{{`</span> éƒ½æœ‰å¯¹åº”çš„ <span v-pre>`}}`</span>

## é”™è¯¯æ¢å¤çš„æ€§èƒ½å½±å“

### é”™è¯¯æ£€æµ‹æˆæœ¬

```
// æ€§èƒ½å¯¹æ¯”

// æ— é”™è¯¯æ¨¡æ¿ï¼ˆæœ€å¿«ï¼‰
Parse time: 0.5ms

// å°æ•°é‡é”™è¯¯ï¼ˆ1-3 ä¸ªï¼‰
Parse time: 0.6ms  // +20% ç”¨äºé”™è¯¯æ¢å¤

// ä¸­ç­‰æ•°é‡é”™è¯¯ï¼ˆ5-10 ä¸ªï¼‰
Parse time: 0.8ms  // +60% ç”¨äºé”™è¯¯æ¢å¤

// å¤§é‡é”™è¯¯ï¼ˆ>20 ä¸ªï¼‰
Parse time: 1.5ms  // +200% ç”¨äºé”™è¯¯æ¢å¤å’Œæ ˆç®¡ç†
```

### æœ€ä½³å®è·µ

```typescript
// âœ… å¥½çš„åšæ³•ï¼šå¯ç”¨å®Œæ•´é”™è¯¯æŠ¥å‘Š
const result = parse(template, {
  onError: (error) => {
    if (error.severity === ErrorSeverity.FATAL) {
      throw error; // ä¸¥é‡é”™è¯¯ç«‹å³åœæ­¢
    }
    // å…¶ä»–é”™è¯¯ç»§ç»­æ”¶é›†
  },
});

// âŒ é¿å…ï¼šè¿‡åº¦é”™è¯¯å¤„ç†
const result = parse(template, {
  onError: (error) => {
    // æ¯ä¸ªé”™è¯¯éƒ½è¯•å›¾ä¿®å¤å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™
    attemptAutoFix(error);
  },
});
```

## IDE å’Œå·¥å…·é›†æˆ

### é”™è¯¯ä¿¡æ¯æ ¼å¼

```typescript
interface DiagnosticMessage {
  code: number;
  message: string;
  category: DiagnosticCategory; // Error | Warning | Suggestion
  start: number; // æ–‡ä»¶åç§»é‡
  length: number;
  file: string;
  line: number;
  column: number;
  source: string; // é”™è¯¯è¡Œçš„æºä»£ç 
}

// è½¬æ¢ä¸º IDE èƒ½ç†è§£çš„æ ¼å¼
function toIDEDiagnostic(error: CompilerError): DiagnosticMessage {
  return {
    code: error.code,
    message: error.message,
    category: 'Error',
    start: error.loc.start.offset,
    length: error.loc.end.offset - error.loc.start.offset,
    file: options.filename,
    line: error.loc.start.line,
    column: error.loc.start.column,
    source: error.loc.source,
  };
}
```

### LSPï¼ˆLanguage Server Protocolï¼‰é›†æˆ

```typescript
function publishDiagnostics(uri: string, errors: CompilerError[]) {
  const diagnostics = errors.map((error) => ({
    range: {
      start: {
        line: error.loc.start.line - 1,
        character: error.loc.start.column - 1,
      },
      end: {
        line: error.loc.end.line - 1,
        character: error.loc.end.column - 1,
      },
    },
    severity: getSeverityForLSP(error.code),
    message: error.message,
    source: 'Vue Parser',
    code: error.code,
  }));

  languageServer.sendDiagnostics({ uri, diagnostics });
}
```

## æ€»ç»“

| æ¦‚å¿µ             | è¯´æ˜                                    |
| ---------------- | --------------------------------------- |
| **é”™è¯¯æ¢å¤**     | Parser åœ¨é‡åˆ°é”™è¯¯æ—¶ç»§ç»­è§£æï¼Œè€Œéåœæ­¢   |
| **å®Œæ•´é”™è¯¯åˆ—è¡¨** | ä¸€æ¬¡æ€§æ”¶é›†æ‰€æœ‰é”™è¯¯ï¼Œæä¾›ç»™å¼€å‘è€…        |
| **AST ç”Ÿæˆ**     | å³ä½¿æœ‰é”™è¯¯ä¹Ÿèƒ½ç”Ÿæˆæœ‰æ•ˆçš„ AST ç”¨äºå·¥å…·é“¾ |
| **æ ˆæœºåˆ¶æ¢å¤**   | é€šè¿‡æ ˆè¿½è¸ªå…ƒç´ åµŒå¥—ï¼Œè‡ªåŠ¨ä¿®å¤ä¸åŒ¹é…      |
| **çŠ¶æ€æœºæ¢å¤**   | çŠ¶æ€æœºå°è¯•æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æ•ˆçŠ¶æ€            |
| **é”™è¯¯ç­‰çº§**     | åŒºåˆ†è­¦å‘Šã€é”™è¯¯ã€ä¸¥é‡é”™è¯¯çš„å¤„ç†æ–¹å¼      |
| **IDE é›†æˆ**     | é”™è¯¯ä¿¡æ¯è½¬æ¢ä¸º IDE è¯Šæ–­æ ¼å¼             |

**è®¾è®¡å“²å­¦**ï¼šParser çš„å®¹é”™è®¾è®¡ä½“ç°äº†"ä¼˜é›…é™çº§"åŸåˆ™â€”â€”å³ä½¿è¾“å…¥æœ‰ç¼ºé™·ï¼Œä¹Ÿå°½å¯èƒ½æä¾›æœ‰ç”¨çš„è¾“å‡ºã€‚è¿™ç§è®¾è®¡å¤§å¹…æå‡äº†å¼€å‘ä½“éªŒï¼Œä½¿å¾—å¼€å‘è€…èƒ½æ›´é«˜æ•ˆåœ°å®šä½å’Œä¿®å¤é—®é¢˜ã€‚
